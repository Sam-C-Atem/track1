<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>South Sudan Cattle Tracker Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary: #007bff;
            --secondary: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #343a40;
            --light: #f8f9fa;
            --sudan-blue: #007229;
            --sudan-red: #da121a;
            --sudan-green: #007229;
            --sudan-yellow: #fcdd09;
            --sudan-black: #000000;
        }
        
        .cow-horn-logo {
            width: 48px;
            height: 48px;
            color: #4338ca;
        }
        
        /* Print styles to hide non-essential elements for a clean report */
        @media print {
            .no-print {
                display: none !important;
            }
            /* Ensure all text is black for printing */
            * {
                color: #000 !important;
                background: #fff !important;
                box-shadow: none !important;
                border-color: #000 !important;
            }
            /* Ensure the grid layout is preserved but simplified */
            .cow-card {
                border: 1px solid #ccc;
                padding: 1rem;
                margin-bottom: 1rem;
                page-break-inside: avoid;
            }
            .grid-cols-2 {
                grid-template-columns: 1fr 1fr;
            }
            .grid-cols-3 {
                grid-template-columns: 1fr 1fr 1fr;
            }

            /* --- START: Footer Print Style Fix --- */
            .print-footer {
                /* Force background and text color printing */
                background-color: #1f2937 !important; /* Tailwind gray-800 */
                color: #d1d5db !important; /* Tailwind gray-300 for text */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                border-top: 1px solid #4b5563 !important; /* Tailwind gray-700 */
            }
            /* Ensure links are readable on the dark background */
            .print-footer a {
                color: #a5b4fc !important; /* Tailwind indigo-300 */
            }
            /* --- END: Footer Print Style Fix --- */
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            background-color: #28a745;
        }
        
        .notification.error {
            background-color: #dc3545;
        }
        
        .notification.warning {
            background-color: #ffc107;
            color: #333;
        }
        
        /* Spinner animation */
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4338ca;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Screen (Initially Visible) -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="flex flex-col items-center mb-6">
                    <!-- Cow Horn Logo -->
                    <div class="mb-4 bg-indigo-100 p-3 rounded-full shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 text-indigo-700">
                            <path d="M12 2C7.3 2 3.4 5.3 3.1 9.9c-.1 1.7.5 3.3 1.5 4.6l-2.4 2.8c-.3.4-.2 1.1.2 1.4.2.2.5.3.7.3.3 0 .6-.1.8-.4l2.4-2.8c1.3.9 2.9 1.5 4.6 1.5 4.7 0 8.6-3.3 8.9-7.9.1-1.7-.5-3.3-1.5-4.6l2.4-2.8c.3-.4.2-1.1-.2-1.4-.2-.2-.5-.3-.7-.3-.3 0-.6.1-.8.4l-2.4 2.8c-1.3-.9-2.9-1.5-4.6-1.5zM12 4c3.4 0 6.2 2.4 6.6 5.7.1 1.2-.3 2.4-.9 3.4l-.5.6c-.4-.3-.8-.6-1.3-.8-1.5-.7-3.2-1.1-4.9-1.1-1.7 0-3.4.4-4.9 1.1-.5.2-.9.5-1.3.8l-.5-.6c-.6-1-1-2.2-.9-3.4C5.8 6.4 8.6 4 12 4z"/>
                        </svg>
                    </div>
                    <!-- Title -->
                    <h3 class="text-2xl font-bold text-gray-900 text-center">South Sudan Animal Tracker Admin</h3>
                    <p class="text-sm text-gray-500 mt-1">Enter credentials to monitor the herd.</p>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                            <i class="fas fa-user w-4 h-4 mr-2 text-indigo-600"></i>
                            Username
                        </label>
                        <input type="text" id="loginUsername" placeholder="Enter Username" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                            <i class="fas fa-lock w-4 h-4 mr-2 text-indigo-600"></i>
                            Password
                        </label>
                        <input type="password" id="loginPassword" placeholder="Enter Password ðŸ”’" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div id="loginError" class="text-red-600 text-sm font-medium bg-red-100 p-2 rounded-lg text-center border border-red-300 hidden"></div>
                    <button type="submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition transform active:scale-[0.99]">
                        Sign In
                    </button>
                </form>
            </div>
            <!-- System Status Message -->
            <div class="mt-4 text-center text-sm text-gray-500">
                System Status: <span id="trackerStatus" class="font-mono text-xs">Initializing system...</span>
            </div>
            <!-- Login Screen Footer -->
            <footer class="mt-4 pt-4 text-center text-xs text-gray-500 border-t border-gray-300">
                <p>&copy; 2024 South Sudan Tracking System Initiative.</p>
                <p>Designed and Developed by Eng: Sam. C. Atem.</p>
                <p class="mt-1">Secure Admin Login Portal.</p>
            </footer>
        </div>
    </div>
    
    <!-- Dashboard (Initially Hidden) -->
    <div id="dashboardScreen" class="hidden">
        <div class="min-h-screen bg-gray-100 p-4 sm:p-6 font-sans">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <header class="mb-8 pb-6 border-b border-gray-300 flex flex-col items-center justify-center text-center">
                    <!-- Cow Horn Logo -->
                    <div class="mb-4 bg-indigo-100 p-4 rounded-full shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-indigo-700">
                            <path d="M12 2C7.3 2 3.4 5.3 3.1 9.9c-.1 1.7.5 3.3 1.5 4.6l-2.4 2.8c-.3.4-.2 1.1.2 1.4.2.2.5.3.7.3.3 0 .6-.1.8-.4l2.4-2.8c1.3.9 2.9 1.5 4.6 1.5 4.7 0 8.6-3.3 8.9-7.9.1-1.7-.5-3.3-1.5-4.6l2.4-2.8c.3-.4.2-1.1-.2-1.4-.2-.2-.5-.3-.7-.3-.3 0-.6.1-.8.4l-2.4 2.8c-1.3-.9-2.9-1.5-4.6-1.5zM12 4c3.4 0 6.2 2.4 6.6 5.7.1 1.2-.3 2.4-.9 3.4l-.5.6c-.4-.3-.8-.6-1.3-.8-1.5-.7-3.2-1.1-4.9-1.1-1.7 0-3.4.4-4.9 1.1-.5.2-.9.5-1.3.8l-.5-.6c-.6-1-1-2.2-.9-3.4C5.8 6.4 8.6 4 12 4z"/>
                        </svg>
                    </div>
                    <!-- Title -->
                    <h2 class="text-3xl font-extrabold text-indigo-700 tracking-tight mb-2">
                        South Sudan Cattle Tracking System
                    </h2>
                    <p class="text-sm text-gray-500">
                        Monitoring <span id="cowCount">0</span> Cellular Trackers in Real-Time.
                    </p>
                    <p class="text-xs text-indigo-500 mt-2 no-print">
                        App ID: <span id="appIdDisplay">default-app-id</span> | User ID: <span id="userIdDisplay">Loading...</span>
                    </p>
                </header>
                
                <!-- Subscription and Simulation Controls -->
                <div class="flex flex-col lg:flex-row gap-4 mb-6 no-print">
                    <!-- Subscription Status Panel -->
                    <div class="lg:w-1/3 bg-white p-4 rounded-xl shadow-lg border-2 border-dashed border-gray-300">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-credit-card w-5 h-5 mr-2 text-indigo-600"></i>
                            <h3 class="font-bold text-lg text-gray-800">Subscription Status</h3>
                        </div>
                        <div class="flex flex-col gap-3">
                            <p class="text-sm font-medium">
                                Status: 
                                <span id="subscriptionStatusBadge" class="ml-2 px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                                    Unknown
                                </span>
                            </p>
                            <button id="toggleSubscriptionBtn"
                                    class="flex items-center justify-center font-medium py-2 px-4 rounded-lg text-sm transition duration-300 bg-green-500 hover:bg-green-600 text-white">
                                <i class="fas fa-unlock w-4 h-4 mr-2"></i>
                                Activate Payment
                            </button>
                        </div>
                    </div>
                    
                    <!-- Simulation and Status Controls -->
                    <div class="lg:w-2/3 flex flex-col gap-4">
                        <!-- Tracker ID Input -->
                        <div class="bg-white p-4 rounded-xl shadow-lg flex items-center gap-3">
                            <i class="fas fa-phone w-5 h-5 text-gray-500 flex-shrink-0"></i>
                            <span class="text-sm font-semibold text-gray-700 flex-shrink-0">+211</span>
                            <input type="tel" id="customTrackerId" placeholder="Enter 9-digit Owner Phone (e.g., 912345678)"
                                   class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                                   maxlength="9">
                        </div>
                        
                        <!-- Action Button -->
                        <button id="simulateReportBtn"
                                class="w-full font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 bg-gray-400 text-gray-700 cursor-not-allowed">
                            <i class="fas fa-tint w-5 h-5 inline mr-2"></i>
                            Reports Blocked
                        </button>
                        
                        <!-- Status Message -->
                        <div class="bg-white p-3 rounded-lg shadow-inner flex items-center">
                            <p class="text-sm font-medium text-gray-700 truncate">
                                System Status: <span id="trackerSystemStatus" class="font-mono text-xs ml-2">Waiting for login...</span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Cow List Rendering -->
                <div id="loadingSpinner" class="text-center py-10 text-lg text-indigo-500 font-semibold hidden">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-indigo-500 border-t-transparent rounded-full mb-3"></div>
                    <p>Loading herd data...</p>
                </div>
                
                <div id="noCowsMessage" class="bg-white p-8 rounded-xl shadow-lg text-center hidden">
                    <i class="fas fa-tint w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="xl font-semibold text-gray-800">No Trackers Reporting</h3>
                    <p class="text-gray-600 mt-2">
                        Enter an Owner Phone and click the "Show Report" button to generate initial data.
                    </p>
                </div>
                
                <div id="cowsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cow cards will be dynamically generated here -->
                </div>
                
                <!-- Footer Section -->
                <footer class="mt-12 pt-6 bg-gray-800 border-t border-gray-700 text-center p-4 rounded-t-xl print-footer">
                    <p class="text-sm font-medium text-gray-300 mb-2">
                        Contact:
                    </p>
                    <p class="text-xs text-gray-400">
                        Email: <a href="mailto:ssdcattletracker.org" class="text-indigo-400 hover:text-indigo-300 font-semibold">ssdcattletracker.org</a>
                    </p>
                    <p class="text-xs text-gray-400 mb-4">
                        Phone: <a href="tel:+211985759001" class="text-indigo-400 hover:text-indigo-300 font-semibold">+211 985 759 001</a>
                    </p>
                    <p class="text-xs text-gray-400">
                        &copy; 2024 South Sudan Tracking System Initiative. All Rights Reserved.
                        
                    </p>
                     <p class="text-xs text-gray-450 mt-1">
                        Designed and Developed by Eng: Sam. C. Atem.
                        
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                        Powered by Cellular IoT and Real-Time Firestore Data.
                        
                    </p>
                </footer>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div class="notification" id="notification"></div>
    
    <script>
        // ======================================================================
        // CATTLE TRACKER APPLICATION JAVASCRIPT
        // ======================================================================
        
        // Tracker application state
        const trackerState = {
            isAuthenticated: false,
            cows: [],
            subscriptionStatus: 'Unknown',
            customTrackerId: '',
            deletingCowId: null,
            userId: null,
            appId: 'default-app-id',
            countryCode: '+211'
        };

        // Admin credentials
        const ADMIN_USERNAME = "Admin";
        const ADMIN_PASSWORD = "admin123";

        // Initialize tracker application
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').addEventListener('submit', handleAppLogin);
            document.getElementById('toggleSubscriptionBtn').addEventListener('click', toggleSubscription);
            document.getElementById('simulateReportBtn').addEventListener('click', simulateDataReport);
            document.getElementById('customTrackerId').addEventListener('input', function(e) {
                trackerState.customTrackerId = e.target.value.replace(/[^0-9]/g, '');
            });
            
            // Initialize with some demo cows for testing
            loadInitialCowsData();
        });

        // Function to handle custom Admin login
        function handleAppLogin(e) {
            e.preventDefault();
            const loginError = document.getElementById('loginError');
            loginError.classList.add('hidden');
            
            const usernameInput = document.getElementById('loginUsername').value.trim();
            const passwordInput = document.getElementById('loginPassword').value.trim();
            
            console.log("Login attempt:", usernameInput, passwordInput);
            
            // 1. Compare Username (Case-sensitive)
            if (usernameInput !== ADMIN_USERNAME) {
                loginError.textContent = "Invalid username or password. Check case ('Admin') and ensure no extra spaces.";
                loginError.classList.remove('hidden');
                updateTrackerStatus("Admin login failed: Invalid username.");
                return;
            }

            // 2. Compare Password (Plain text)
            if (passwordInput === ADMIN_PASSWORD) {
                trackerState.isAuthenticated = true;
                updateTrackerStatus("Admin login successful. Access granted.");
                
                // Show dashboard, hide login
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardScreen').classList.remove('hidden');
                
                // Update app ID display
                document.getElementById('appIdDisplay').textContent = trackerState.appId;
                document.getElementById('userIdDisplay').textContent = "Demo-User-001";
                
                // Update subscription to Active for demo
                trackerState.subscriptionStatus = 'Active';
                updateSubscriptionUI();
                updateSimulateButton();
                
                // Render cows
                renderCows();
                
                showNotification("Login successful! Welcome to the Cattle Tracking Dashboard.", "success");
            } else {
                loginError.textContent = "Invalid password. Please ensure you entered 'admin123' and check for extra spaces.";
                loginError.classList.remove('hidden');
                updateTrackerStatus("Admin login failed: Password mismatch.");
                showNotification("Login failed. Please check your credentials.", "error");
            }
        }

        // Toggle subscription status
        function toggleSubscription() {
            const newStatus = trackerState.subscriptionStatus === 'Active' ? 'Inactive' : 'Active';
            trackerState.subscriptionStatus = newStatus;
            
            updateSubscriptionUI();
            updateTrackerStatus(`Subscription set to ${newStatus} successfully.`);
            
            // Update simulate button state
            updateSimulateButton();
            
            showNotification(`Subscription ${newStatus === 'Active' ? 'activated' : 'deactivated'} successfully.`, "success");
        }

        // Simulate data report
        function simulateDataReport() {
            if (!trackerState.isAuthenticated) {
                updateTrackerStatus("ERROR: Must be logged in to simulate data.");
                showNotification("Please login first.", "error");
                return;
            }
            
            if (trackerState.subscriptionStatus !== 'Active') {
                updateTrackerStatus("ERROR: Tracker reports are blocked because the Subscription is Inactive.");
                showNotification("Subscription is inactive. Please activate to generate reports.", "warning");
                return;
            }
            
            // Determine the tracker ID to use
            let newCowId = trackerState.customTrackerId.trim();
            
            if (newCowId) {
                // Validate it's exactly 9 digits
                if (newCowId.length !== 9) {
                    showNotification("Phone number must be exactly 9 digits (e.g., 912345678)", "warning");
                    return;
                }
                
                if (!newCowId.startsWith(trackerState.countryCode)) {
                    newCowId = trackerState.countryCode + newCowId;
                }
            } else {
                // Generate random phone number starting with 9 (typical South Sudan mobile)
                const randomSuffix = Math.floor(900000000 + Math.random() * 99999999).toString().substring(0, 9);
                newCowId = trackerState.countryCode + randomSuffix;
            }
            
            // Check if this ID already exists
            if (trackerState.cows.some(cow => cow.id === newCowId)) {
                showNotification("Tracker with this phone number already exists.", "warning");
                return;
            }
            
            // Create new cow data
            const uniqueSuffix = newCowId.slice(-3);
            const cowNameBase = `Bessie-${uniqueSuffix}`;
            
            // Generate random South Sudan coordinates (within South Sudan boundaries)
            const randomLat = 4.0 + (Math.random() * 6); // Between 4-10Â°N
            const randomLon = 29.0 + (Math.random() * 6); // Between 29-35Â°E
            const randomSignal = Math.floor(Math.random() * 4) + 1;
            const randomBattery = Math.floor(Math.random() * 100);
            const activities = ['Grazing', 'Resting', 'Moving', 'Drinking Water', 'In Shelter'];
            const randomActivity = activities[Math.floor(Math.random() * activities.length)];
            
            const cowData = {
                id: newCowId,
                cowName: cowNameBase,
                latitude: parseFloat(randomLat.toFixed(6)),
                longitude: parseFloat(randomLon.toFixed(6)),
                signalBars: randomSignal,
                batteryPercent: randomBattery,
                activity: randomActivity,
                lastReport: new Date().toLocaleString()
            };
            
            // Add to cows array
            trackerState.cows.push(cowData);
            
            // Update UI
            renderCows();
            updateTrackerStatus(`Simulated report from ${formatPhoneId(newCowId)} successfully!`);
            showNotification(`New tracker report created: ${cowNameBase}`, "success");
            
            // Clear input
            document.getElementById('customTrackerId').value = '';
            trackerState.customTrackerId = '';
        }

        // Format phone ID for display
        function formatPhoneId(id) {
            if (id.startsWith('+211') && id.length >= 13) {
                const num = id.substring(4);
                if (num.length >= 9) {
                    return `+211 ${num.substring(0, 3)} ${num.substring(3, 6)} ${num.substring(6, 9)}`;
                }
            }
            return id;
        }

        // Load initial cows data
        function loadInitialCowsData() {
            // Generate some initial sample data for demo
            trackerState.cows = [
                {
                    id: '+211912345678',
                    cowName: 'Bessie-678',
                    latitude: 4.8594,
                    longitude: 31.5713,
                    signalBars: 4,
                    batteryPercent: 85,
                    activity: 'Grazing',
                    lastReport: new Date().toLocaleString()
                },
                {
                    id: '+211987654321',
                    cowName: 'Daisy-321',
                    latitude: 4.8512,
                    longitude: 31.5821,
                    signalBars: 3,
                    batteryPercent: 65,
                    activity: 'Resting',
                    lastReport: new Date(Date.now() - 3600000).toLocaleString()
                },
                {
                    id: '+211956789123',
                    cowName: 'Moo-Moo-123',
                    latitude: 4.8723,
                    longitude: 31.6123,
                    signalBars: 2,
                    batteryPercent: 42,
                    activity: 'Moving',
                    lastReport: new Date(Date.now() - 7200000).toLocaleString()
                }
            ];
            
            updateTrackerStatus(`System ready. Demo data loaded with ${trackerState.cows.length} trackers.`);
        }

        // Render cows to the UI
        function renderCows() {
            const cowsGrid = document.getElementById('cowsGrid');
            const cowCount = document.getElementById('cowCount');
            const noCowsMessage = document.getElementById('noCowsMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // Hide loading spinner if visible
            loadingSpinner.classList.add('hidden');
            
            cowCount.textContent = trackerState.cows.length;
            
            if (trackerState.cows.length === 0) {
                noCowsMessage.classList.remove('hidden');
                cowsGrid.innerHTML = '';
                return;
            }
            
            noCowsMessage.classList.add('hidden');
            
            // Clear and rebuild the grid
            cowsGrid.innerHTML = '';
            
            trackerState.cows.forEach(cow => {
                const cowCard = createCowCard(cow);
                cowsGrid.appendChild(cowCard);
            });
        }

        // Create a cow card element
        function createCowCard(cow) {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-xl shadow-lg border-t-4 border-indigo-500 hover:shadow-xl transition duration-300 cow-card';
            
            const batteryColor = getBatteryColor(cow.batteryPercent);
            const signalColor = getSignalColor(cow.signalBars);
            const isDeleting = trackerState.deletingCowId === cow.id;
            
            card.innerHTML = `
                <h2 class="text-xl font-bold text-gray-900 truncate mb-2">${cow.cowName}</h2>
                
                <div class="flex items-center text-sm font-mono text-gray-600 mb-4">
                    <i class="fas fa-phone w-4 h-4 mr-2 text-indigo-500"></i>
                    <span class="font-semibold text-gray-700">Owner Phone/ID:</span> 
                    <span class="ml-2">${formatPhoneId(cow.id)}</span>
                </div>

                <div class="grid grid-cols-2 gap-y-3 gap-x-2 text-sm">
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-clock w-4 h-4 mr-2 text-indigo-500"></i>
                        <span class="font-semibold">Last Report:</span>
                    </div>
                    <span class="truncate text-right">${cow.lastReport}</span>

                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-battery-full w-4 h-4 mr-2 ${batteryColor}"></i>
                        <span class="font-semibold">Battery:</span>
                    </div>
                    <span class="font-bold text-right ${batteryColor}">${cow.batteryPercent}%</span>

                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-signal w-4 h-4 mr-2 ${signalColor}"></i>
                        <span class="font-semibold">Signal:</span>
                    </div>
                    <span class="font-bold text-right ${signalColor}">${cow.signalBars} Bar(s)</span>

                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-tint w-4 h-4 mr-2 text-purple-500"></i>
                        <span class="font-semibold">Activity:</span>
                    </div>
                    <span class="font-medium text-right text-gray-800">${cow.activity}</span>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex items-center text-sm text-gray-700 font-semibold mb-2">
                        <i class="fas fa-map-marker-alt w-4 h-4 mr-2 text-pink-500"></i>
                        Current Location
                    </div>
                    <p class="text-xs font-mono bg-gray-50 p-2 rounded-md mb-2">
                        Lat: ${cow.latitude}, Lon: ${cow.longitude}
                    </p>

                    <div class="flex gap-2 mt-2 no-print">
                        <a href="https://www.google.com/maps/search/?api=1&query=${cow.latitude},${cow.longitude}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="flex-1 block text-center text-xs font-medium py-2 rounded-md bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition active:bg-indigo-200">
                            View on Map
                        </a>
                        <button onclick="handleSinglePrint(${JSON.stringify(cow).replace(/"/g, '&quot;')})"
                                class="flex-1 flex items-center justify-center text-xs font-medium py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 transition transform active:scale-[0.98]">
                            <i class="fas fa-print w-3 h-3 mr-1"></i>
                            Print Card
                        </button>
                        
                        <button onclick="handleDeleteCow('${cow.id}')"
                                class="flex-1 flex items-center justify-center text-xs font-medium py-2 rounded-md transition duration-300 transform active:scale-[0.98] ${isDeleting ? 'bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg' : 'bg-red-100 hover:bg-red-200 text-red-600'}">
                            ${isDeleting ? (
                                '<i class="fas fa-unlock w-3 h-3 mr-1"></i> Confirm'
                            ) : (
                                '<i class="fas fa-trash w-3 h-3 mr-1"></i> Delete'
                            )}
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Handle delete cow
        function handleDeleteCow(cowId) {
            if (trackerState.deletingCowId === cowId) {
                // Confirmation step: Proceed with deletion
                const cowName = trackerState.cows.find(cow => cow.id === cowId)?.cowName || 'Unknown';
                trackerState.cows = trackerState.cows.filter(cow => cow.id !== cowId);
                trackerState.deletingCowId = null;
                renderCows();
                updateTrackerStatus(`Successfully deleted tracker report: ${formatPhoneId(cowId)}.`);
                showNotification(`Deleted tracker: ${cowName}`, "success");
            } else {
                // First click: Set the ID to show the confirmation button
                trackerState.deletingCowId = cowId;
                updateTrackerStatus(`Click CONFIRM DELETE again for ${formatPhoneId(cowId)}.`);
                renderCows(); // Re-render to update the button state
            }
        }

        // Handle single print
        function handleSinglePrint(cow) {
            const formattedId = formatPhoneId(cow.id);
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Tracker Report - ${cow.cowName}</title>
                    <style>
                        @page { margin: 1cm; }
                        body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 100%; }
                        .logo-container { text-align: center; margin-bottom: 20px; }
                        .horn-svg { width: 48px; height: 48px; color: #4338ca; }
                        h1 { color: #4338ca; border-bottom: 2px solid #ccc; padding-bottom: 5px; text-align: center; }
                        p.id { text-align: center; margin-bottom: 20px; font-weight: 500;}
                        .report-section { margin-top: 15px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                        .report-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
                        .label { font-weight: bold; color: #374151; }
                        .value { color: #1f2937; }
                        .location-link { font-style: italic; color: #6b7280; margin-top: 20px; text-align: center; font-size: 0.9em; }
                        .legal-notice {
                            margin-top: 20px;
                            font-size: 0.75em;
                            color: #6b7280;
                            text-align: center;
                            border: 1px dashed #fca5a5;
                            padding: 10px;
                            border-radius: 4px;
                            background: #fee2e2;
                            font-weight: bold;
                        }
                        .contact-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; text-align: center; }
                        .contact-section h4 { margin-bottom: 8px; color: #4338ca; font-size: 1.1em; }
                        .contact-item { margin: 5px 0; font-size: 0.9em; }
                        .contact-label { font-weight: bold; margin-right: 5px; }
                    </style>
                </head>
                <body>
                    <div class="logo-container">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="horn-svg">
                            <path d="M12 2C7.3 2 3.4 5.3 3.1 9.9c-.1 1.7.5 3.3 1.5 4.6l-2.4 2.8c-.3.4-.2 1.1.2 1.4.2.2.5.3.7.3.3 0 .6-.1.8-.4l2.4-2.8c1.3.9 2.9 1.5 4.6 1.5 4.7 0 8.6-3.3 8.9-7.9.1-1.7-.5-3.3-1.5-4.6l2.4-2.8c.3-.4.2-1.1-.2-1.4-.2-.2-.5-.3-.7-.3-.3 0-.6.1-.8.4l-2.4 2.8c-1.3-.9-2.9-1.5-4.6-1.5zM12 4c3.4 0 6.2 2.4 6.6 5.7.1 1.2-.3 2.4-.9 3.4l-.5.6c-.4-.3-.8-.6-1.3-.8-1.5-.7-3.2-1.1-4.9-1.1-1.7 0-3.4.4-4.9 1.1-.5.2-.9.5-1.3.8l-.5-.6c-.6-1-1-2.2-.9-3.4C5.8 6.4 8.6 4 12 4z"/>
                        </svg>
                    </div>

                    <h1>South Sudan Cattle Tracker Report: ${cow.cowName}</h1>
                    <p class="id">Owner Phone/ID: ${formattedId}</p>
                    <p class="location-link">Report Generated: ${new Date().toLocaleString()}</p>
                    
                    <div class="report-section">
                        <div class="report-item"><span class="label">Last Report:</span> <span class="value">${cow.lastReport}</span></div>
                        <div class="report-item"><span class="label">Activity:</span> <span class="value">${cow.activity}</span></div>
                        <div class="report-item"><span class="label">Battery:</span> <span class="value">${cow.batteryPercent}%</span></div>
                        <div class="report-item"><span class="label">Signal:</span> <span class="value">${cow.signalBars} Bar(s)</span></div>
                        <div class="report-item"><span class="label">Latitude:</span> <span class="value">${cow.latitude}</span></div>
                        <div class="report-item"><span class="label">Longitude:</span> <span class="value">${cow.longitude}</span></div>
                    </div>

                    <p class="location-link">View on Map: https://www.google.com/maps/search/?api=1&query=${cow.latitude},${cow.longitude}</p>

                    <p class="legal-notice">
                        NB: "This report is a property of South Sudan Cattle Tracker and its details are to be used where South Sudan Laws apply"
                    </p>

                    <div class="contact-section">
                        <h4>Contact Information</h4>
                        <div class="contact-item">
                            <span class="contact-label">Email:</span> ssdcattletracker.org
                        </div>
                        <div class="contact-item">
                            <span class="contact-label">Phone:</span> +211 985 759 001
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                
                updateTrackerStatus(`Preparing print report for ${cow.cowName}.`);
                
                setTimeout(() => {
                    try {
                        printWindow.print();
                    } catch(e) {
                        console.error("Print failed:", e);
                    } finally {
                        setTimeout(() => printWindow.close(), 100);
                    }
                }, 300);
            } else {
                updateTrackerStatus("ERROR: Please allow popups in your browser to generate the individual print report.");
                showNotification("Please allow popups to print reports.", "warning");
            }
        }

        // Utility functions
        function getBatteryColor(percent) {
            if (percent > 70) return 'text-green-500';
            if (percent > 30) return 'text-yellow-500';
            return 'text-red-500';
        }

        function getSignalColor(bars) {
            if (bars === 4) return 'text-green-500';
            if (bars >= 2) return 'text-yellow-500';
            return 'text-red-500';
        }

        // Update subscription UI
        function updateSubscriptionUI() {
            const isPaid = trackerState.subscriptionStatus === 'Active';
            const badge = document.getElementById('subscriptionStatusBadge');
            const button = document.getElementById('toggleSubscriptionBtn');
            
            if (isPaid) {
                badge.className = 'ml-2 px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700';
                badge.textContent = 'Active';
                
                button.className = 'flex items-center justify-center font-medium py-2 px-4 rounded-lg text-sm transition duration-300 bg-red-500 hover:bg-red-600 text-white';
                button.innerHTML = '<i class="fas fa-lock w-4 h-4 mr-2"></i> Deactivate Now';
            } else {
                badge.className = 'ml-2 px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700';
                badge.textContent = 'Inactive';
                
                button.className = 'flex items-center justify-center font-medium py-2 px-4 rounded-lg text-sm transition duration-300 bg-green-500 hover:bg-green-600 text-white';
                button.innerHTML = '<i class="fas fa-unlock w-4 h-4 mr-2"></i> Activate Payment';
            }
        }

        // Update simulate button
        function updateSimulateButton() {
            const isPaid = trackerState.subscriptionStatus === 'Active';
            const button = document.getElementById('simulateReportBtn');
            
            if (isPaid) {
                button.className = 'w-full font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 bg-indigo-600 hover:bg-indigo-700 text-white transform hover:scale-[1.01] active:scale-[0.99]';
                button.innerHTML = '<i class="fas fa-tint w-5 h-5 inline mr-2"></i> Show Report';
            } else {
                button.className = 'w-full font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 bg-gray-400 text-gray-700 cursor-not-allowed';
                button.innerHTML = '<i class="fas fa-tint w-5 h-5 inline mr-2"></i> Reports Blocked';
            }
        }

        // Update tracker status message
        function updateTrackerStatus(message) {
            document.getElementById('trackerStatus').textContent = message;
            document.getElementById('trackerSystemStatus').textContent = message;
        }

        // Show notification
        function showNotification(message, type = "info") {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.className = "notification";
            }, 5000);
        }

        // Make functions available globally for inline onclick handlers
        window.handleDeleteCow = handleDeleteCow;
        window.handleSinglePrint = handleSinglePrint;
    </script>
</body>

</html>



